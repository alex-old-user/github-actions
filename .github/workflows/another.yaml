name: CI

on:
  pull_request:
    branches: [main]
  
jobs:
  # JOB to run change detection
  changes:
    runs-on: ubuntu-latest
    # Required permissions
    permissions:
      pull-requests: read
    outputs:
      # Expose matched filters as job 'packages' output variable
      packages: ${{ steps.filter.outputs.changes }}
    steps:
    # For pull requests it's not necessary to checkout the code
    - uses: dorny/paths-filter@v2
      id: filter
      with:
        filters: |
          p1: services/p1/**
          p2: services/p1/**

  build:
    needs: changes
    strategy:
      matrix:
        package: ${{ fromJSON(needs.changes.outputs.packages) }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: pwd;  echo pull > services/${{ matrix.package }}/file

      - uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.package }}
          path: services/${{ matrix.package }}/file

  commit:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/download-artifact@v3
        with:
          path: tmp
      # - run: ls tmp/p1          
      - run: |
          pushd tmp
          for FILE in *; do mv $FILE/file ../services/$FILE/file ; done
          popd && rm -rf tmp

      - uses: stefanzweifel/git-auto-commit-action@v4
        id: push
        with:
          commit_message: Bump image version
      - name: Set final commit status
        uses: myrotvorets/set-commit-status-action@master
        if: always()
        with:
          sha: ${{ steps.push.outputs.commit_hash }}
          token: ${{ secrets.GITHUB_TOKEN }}
          context: Publish NPM package
          status: ${{ job.status }}
